<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=600">
    <style type="text/css">html {
    width: 100%;
    height: 100%;
    margin: 0;
    font-size: 62.5%;
    font-family: sans-serif;
    font-feature-settings: "palt";
    letter-spacing: 0.02rem;
    overflow-x: hidden;
}

@media (max-width: 600px) {
    html {
        font-size: 75%;
    }
}

body {
    width: 600px;
    margin: auto;
    font-size: 2rem;
    line-height: 1.73;
    color: hsl(235, 20%, 30%);
    background-color: hsl(25, 50%, 99%);
}

header {
    padding: 20px;
    letter-spacing: -0.2rem;
}

footer {
    padding: 20px;
    text-align: right;
    letter-spacing: -0.2rem;
}

.articles {
    list-style: none;
    margin: 0 20px;
    padding: 0;
}

.articles > li {
    margin: 40px 0;
}

.articles > li > a {
    display: grid;
    grid-template-columns: auto 1fr;
    grid-gap: 2rem;
}

.articles > li > a > div:first-child {
    white-space: nowrap;
}

.articles > li > a > div:last-child {
    white-space: pre-wrap;
    word-break: break-all;
    word-wrap: break-word;
}

article {
    margin-top: 80px;
    margin-bottom: 80px;
    padding: 20px;
}

h1 {
    margin: 10px 0 20px;
    font-size: 2.4rem;
    text-align: center;
}

h2 {
    margin: 80px 0 20px;
    font-size: 2.2rem;
    text-align: center;
}

h3 {
    margin: 80px 0 20px;
    font-size: 1.8rem;
    font-weight: normal;
    text-align: center;
}

img {
    display: block;
    max-width: 100%;
    margin: 0 auto;
}

.highlighttable {
    table-layout: fixed;
    width: 600px;
    background-color: #272822;
    border-spacing: 0;
}

@media (min-width: 601px) {
    .highlighttable {
        margin-left: -1000%;
        margin-right: -1000%;
        padding-left: 1000%;
        padding-right: 1000%;
    }
}

@media (max-width: 600px) {
    .highlighttable {
        margin-left: -20px;
        margin-right: -20px;
    }
}

.highlighttable .linenos {
    width: 22px;
    padding-left: 2px;
    padding-right: 6px;
    color: #f8f8f2;
    text-align: right;
}

.highlighttable .code {
    width: 566px;
    padding-left: 2px;
    padding-right: 2px;
    overflow-x: scroll;
}
.highlight .hll { background-color: #49483e }
.highlight  { background: #272822; color: #f8f8f2 }
.highlight .c { color: #75715e } /* Comment */
.highlight .err { color: #960050; background-color: #1e0010 } /* Error */
.highlight .k { color: #66d9ef } /* Keyword */
.highlight .l { color: #ae81ff } /* Literal */
.highlight .n { color: #f8f8f2 } /* Name */
.highlight .o { color: #f92672 } /* Operator */
.highlight .p { color: #f8f8f2 } /* Punctuation */
.highlight .ch { color: #75715e } /* Comment.Hashbang */
.highlight .cm { color: #75715e } /* Comment.Multiline */
.highlight .cp { color: #75715e } /* Comment.Preproc */
.highlight .cpf { color: #75715e } /* Comment.PreprocFile */
.highlight .c1 { color: #75715e } /* Comment.Single */
.highlight .cs { color: #75715e } /* Comment.Special */
.highlight .gd { color: #f92672 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gi { color: #a6e22e } /* Generic.Inserted */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #75715e } /* Generic.Subheading */
.highlight .kc { color: #66d9ef } /* Keyword.Constant */
.highlight .kd { color: #66d9ef } /* Keyword.Declaration */
.highlight .kn { color: #f92672 } /* Keyword.Namespace */
.highlight .kp { color: #66d9ef } /* Keyword.Pseudo */
.highlight .kr { color: #66d9ef } /* Keyword.Reserved */
.highlight .kt { color: #66d9ef } /* Keyword.Type */
.highlight .ld { color: #e6db74 } /* Literal.Date */
.highlight .m { color: #ae81ff } /* Literal.Number */
.highlight .s { color: #e6db74 } /* Literal.String */
.highlight .na { color: #a6e22e } /* Name.Attribute */
.highlight .nb { color: #f8f8f2 } /* Name.Builtin */
.highlight .nc { color: #a6e22e } /* Name.Class */
.highlight .no { color: #66d9ef } /* Name.Constant */
.highlight .nd { color: #a6e22e } /* Name.Decorator */
.highlight .ni { color: #f8f8f2 } /* Name.Entity */
.highlight .ne { color: #a6e22e } /* Name.Exception */
.highlight .nf { color: #a6e22e } /* Name.Function */
.highlight .nl { color: #f8f8f2 } /* Name.Label */
.highlight .nn { color: #f8f8f2 } /* Name.Namespace */
.highlight .nx { color: #a6e22e } /* Name.Other */
.highlight .py { color: #f8f8f2 } /* Name.Property */
.highlight .nt { color: #f92672 } /* Name.Tag */
.highlight .nv { color: #f8f8f2 } /* Name.Variable */
.highlight .ow { color: #f92672 } /* Operator.Word */
.highlight .w { color: #f8f8f2 } /* Text.Whitespace */
.highlight .mb { color: #ae81ff } /* Literal.Number.Bin */
.highlight .mf { color: #ae81ff } /* Literal.Number.Float */
.highlight .mh { color: #ae81ff } /* Literal.Number.Hex */
.highlight .mi { color: #ae81ff } /* Literal.Number.Integer */
.highlight .mo { color: #ae81ff } /* Literal.Number.Oct */
.highlight .sa { color: #e6db74 } /* Literal.String.Affix */
.highlight .sb { color: #e6db74 } /* Literal.String.Backtick */
.highlight .sc { color: #e6db74 } /* Literal.String.Char */
.highlight .dl { color: #e6db74 } /* Literal.String.Delimiter */
.highlight .sd { color: #e6db74 } /* Literal.String.Doc */
.highlight .s2 { color: #e6db74 } /* Literal.String.Double */
.highlight .se { color: #ae81ff } /* Literal.String.Escape */
.highlight .sh { color: #e6db74 } /* Literal.String.Heredoc */
.highlight .si { color: #e6db74 } /* Literal.String.Interpol */
.highlight .sx { color: #e6db74 } /* Literal.String.Other */
.highlight .sr { color: #e6db74 } /* Literal.String.Regex */
.highlight .s1 { color: #e6db74 } /* Literal.String.Single */
.highlight .ss { color: #e6db74 } /* Literal.String.Symbol */
.highlight .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #a6e22e } /* Name.Function.Magic */
.highlight .vc { color: #f8f8f2 } /* Name.Variable.Class */
.highlight .vg { color: #f8f8f2 } /* Name.Variable.Global */
.highlight .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.highlight .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.highlight .il { color: #ae81ff } /* Literal.Number.Integer.Long */
</style>
    <title>HTMLとCSSとJavaScriptで空白と改行を削除するWebアプリを作ったので詳細説明します | 5000164 is here</title>
    <link href="/favicon.ico" rel="icon">
    <link href="http://blog.5000164.jp/2013-11-space_delete/" rel="canonical">
    <meta name="generator" content="Hugo 0.31.1" />
</head>
<body>
<header>
    <a href="http://blog.5000164.jp">5000164 is here</a>
</header>

<article>
    <div>2013-11-29</div>
    <h1>HTMLとCSSとJavaScriptで空白と改行を削除するWebアプリを作ったので詳細説明します</h1>
    


<figure >
    
        <img src="/images/2013/11/20131129_space_delete.png" />
    
    
</figure>


<h2 id="作ったもの">作ったもの</h2>

<p>まずは実際に作ったものです。<br />
見てからの方がわかりやすいと思います。<br />
<a href="http://5000164.jp/space_delete/" title="空白改行削除 | 5000164 here.">空白改行削除 | 5000164 here.</a></p>

<h2 id="概要">概要</h2>

<p>半角スペース、全角スペース、タブ、改行を削除できます。</p>

<h2 id="機能">機能</h2>

<h3 id="改行削除">改行削除</h3>

<p>改行を削除して出力領域に書き出し。<br />
ショートカットキーはCtrl + Enter。<br />
書き出したらテキストは全選択の状態なのでそのままコピー可。</p>

<h3 id="空白削除">空白削除</h3>

<p>半角スペース、全角スペース、タブを削除して編集領域に上書き。<br />
ショートカットキーはShift + Enter。<br />
空白の削除前に戻したい場合はCtrl + Alt + Z。</p>

<h3 id="空白改行削除">空白改行削除</h3>

<p>半角スペース、全角スペース、タブ、改行を削除して出力領域に書き出し。<br />
ショートカットキーはCtrl + Shift + Enter。</p>

<h3 id="補助機能">補助機能</h3>

<p>TabキーでTab文字の挿入。<br />
Shift + Tabで行頭のTab文字を削除。<br />
範囲を選択して削除した場合は選択範囲に対して処理の実行。<br />
範囲を選択してTab、Shift + Tabを押した場合には選択行に対して実行。</p>

<h2 id="実装解説">実装解説</h2>

<p>それではHTMLとCSSとJavaScriptについて各部分の詳細を説明します。</p>

<h2 id="実装解説-html">実装解説：HTML</h2>

<p>メインの部分はこんな感じです。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-html" data-lang="html"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button_wrapper&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button&quot;</span><span class="p">&gt;&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;space_delete_flg&quot;</span><span class="p">&gt;&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;space_button&quot;</span><span class="p">&gt;</span>空白<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button&quot;</span><span class="p">&gt;&lt;</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;newline_delete_flg&quot;</span> <span class="na">checked</span><span class="p">&gt;&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;newline_button&quot;</span><span class="p">&gt;</span>改行<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;&lt;/</span><span class="nt">label</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;delete_button&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button&quot;</span><span class="p">&gt;</span>削除<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://5000164.jp/2013-11-space_delete/&quot;</span> <span class="na">target</span><span class="o">=</span><span class="s">&quot;_blank&quot;</span><span class="p">&gt;&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;info&quot;</span><span class="p">&gt;</span>i<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input_wrapper&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input_area&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input_background&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;output_area&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;result&quot;</span> <span class="na">readonly</span><span class="p">&gt;&lt;/</span><span class="nt">input</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></table>
<p>タグ構造は非常にシンプルです。<br />
今回はtextareaに入力した内容に合わせて背景色を変えるという処理を行っているので、textareaとdivタグを重ねています。<br />
ただ、contenteditableを使えば1つのタグだけでいけるのかもしれません。<br />
textareaとdivタグを重ねる手法だと、常に内容を同期させる必要があるので処理が重くなる可能性があります。<br />
ちょっとした入力内容から大丈夫かも知れませんが、次に同じようなことをしたくなったらcontenteditableでやります。</p>

<h2 id="実装解説-css">実装解説：CSS</h2>

<p>今回のCSSでは、編集領域をウィンドウサイズに合わせる、空白などの見えない文字を可視化する、ボタンを押した時にテキストが動く、というところがメインです。</p>

<h3 id="編集領域をウィンドウサイズに合わせる">編集領域をウィンドウサイズに合わせる</h3>

<p>まずは編集領域をウィンドウサイズに合わせる部分から。<br />
重要になるのはこのへんです。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-css" data-lang="css"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-css" data-lang="css"><span></span><span class="nt">html</span><span class="o">,</span> <span class="nt">body</span> <span class="p">{</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">15</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_wrapper</span> <span class="p">{</span>
  <span class="k">box-sizing</span><span class="p">:</span> <span class="kc">border-box</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">min-width</span><span class="p">:</span> <span class="mi">640</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">15</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>あんまり見なれないheight: 100%;が重要になります。<br />
私は初めて使った気がします。<br />
height: 100%;を使うためには、htmlとbodyにheight: 100%;を指定する必要があります。<br />
これ重要です。<br />
あとはコンテンツ部分にもheight: 100%;を指定して、paddingで上下の余白を調整してあげれば、コンテンツの高さを自動でウィンドウサイズに合わせることができます。</p>

<h3 id="空白などの見えない文字を可視化する">空白などの見えない文字を可視化する</h3>

<p>まずはtextareaとdivタグがずれないようにちゃんとスタイルを合わせます。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-css" data-lang="css"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-css" data-lang="css"><span></span><span class="p">#</span><span class="nn">input_area</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="k">box-sizing</span><span class="p">:</span> <span class="kc">border-box</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">min-width</span><span class="p">:</span> <span class="mi">640</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input</span> <span class="p">{</span>
  <span class="k">z-index</span><span class="p">:</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
  <span class="k">top</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">box-sizing</span><span class="p">:</span> <span class="kc">border-box</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">min-width</span><span class="p">:</span> <span class="mi">610</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">0</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">resize</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
  <span class="k">word-break</span><span class="p">:</span> <span class="n">break-all</span><span class="p">;</span>
  <span class="k">word-wrap</span><span class="p">:</span> <span class="kc">break-word</span><span class="p">;</span>
  <span class="k">white-space</span><span class="p">:</span> <span class="kc">pre-wrap</span><span class="p">;</span>
  <span class="k">font-family</span><span class="p">:</span> <span class="kc">sans-serif</span><span class="p">;</span>
  <span class="k">font-size</span><span class="p">:</span> <span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">line-height</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">85</span><span class="kt">%</span><span class="p">);</span>
  <span class="k">background</span><span class="p">:</span> <span class="kc">transparent</span><span class="p">;</span>
  <span class="k">border</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
  <span class="k">outline</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="p">{</span>
  <span class="k">z-index</span><span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
  <span class="k">top</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">overflow-y</span><span class="p">:</span> <span class="kc">auto</span><span class="p">;</span>
  <span class="k">box-sizing</span><span class="p">:</span> <span class="kc">border-box</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">min-width</span><span class="p">:</span> <span class="mi">610</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">0</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">word-break</span><span class="p">:</span> <span class="n">break-all</span><span class="p">;</span>
  <span class="k">word-wrap</span><span class="p">:</span> <span class="kc">break-word</span><span class="p">;</span>
  <span class="k">white-space</span><span class="p">:</span> <span class="kc">pre-wrap</span><span class="p">;</span>
  <span class="k">font-family</span><span class="p">:</span> <span class="kc">sans-serif</span><span class="p">;</span>
  <span class="k">font-size</span><span class="p">:</span> <span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">line-height</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="kc">transparent</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>ここではまず、親要素にposition: relative;を指定して、子要素にposition: absolute;のtop: 0;left: 0;で位置を合わせ、文字のスタイルなどを一致させます。<br />
そしてtextareaをbackground: transparent;とすることで後ろのdivタグが見えるようになります。<br />
divタグにはcolor: transparent;と指定してテキストが見えないようにします。<br />
これで表示する位置を合わせたら、次は実際に表示させます。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-css" data-lang="css"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-css" data-lang="css"><span></span><span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span> <span class="p">{</span>
  <span class="k">display</span><span class="p">:</span> <span class="kc">inline</span><span class="p">;</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">white-space</span><span class="p">:</span> <span class="kc">pre-wrap</span><span class="p">;</span>
  <span class="k">font-family</span><span class="p">:</span> <span class="kc">sans-serif</span><span class="p">;</span>
  <span class="k">font-size</span><span class="p">:</span> <span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">line-height</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
  <span class="k">top</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">font-family</span><span class="p">:</span> <span class="kc">sans-serif</span><span class="p">;</span>
  <span class="k">font-size</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">line-height</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">40</span><span class="kt">%</span><span class="p">);</span>
  <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">space</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">20</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">space</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;･&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">em_space</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">20</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">em_space</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;□&quot;</span><span class="p">;</span>
  <span class="k">font-size</span><span class="p">:</span> <span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">tab</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">20</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">tab</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;→&quot;</span><span class="p">;</span>
  <span class="k">text-align</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">crlf</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">20</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">crlf</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;←↓&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">cr</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">20</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">cr</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;←&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">lf</span> <span class="p">{</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">20</span><span class="kt">%</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">input_background</span> <span class="o">&gt;</span> <span class="nt">pre</span><span class="p">.</span><span class="nc">lf</span><span class="p">:</span><span class="nd">after</span> <span class="p">{</span>
  <span class="k">content</span><span class="p">:</span> <span class="s2">&quot;↓&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>ここではJavaScriptで該当の文字をpreタグで囲い、該当の文字ごとにクラス名が付けられる、という前提でのスタイルです。<br />
例えば、pre.spaceがあったら、背景を変えて「･」を表示させるようにしています。<br />
実際にpreタグの中に「･」を入れてしまうとtextareaとdivタグで内容が一致しなくなってしまうので、擬似要素を使って表示しています。</p>

<h3 id="ボタンを押した時にテキストが動く">ボタンを押した時にテキストが動く</h3>

<p>ここでは私がかねてから実装してみたかった、バウンスするようなアニメーションを適用しています。<br />
例として空白ボタンを見てみます。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-css" data-lang="css">1
2
3
4
5
6
7
8</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-css" data-lang="css"><span></span><span class="nt">header</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">checkbox</span><span class="o">]</span><span class="p">:</span><span class="nd">checked</span> <span class="o">+</span> <span class="p">#</span><span class="nn">space_button</span> <span class="p">{</span>
  <span class="k">background</span><span class="p">:</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">5</span><span class="kt">%</span><span class="p">);</span>
  <span class="k">border</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">4</span><span class="kt">%</span><span class="p">);</span>
  <span class="k">box-shadow</span><span class="p">:</span> <span class="mi">0</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span> <span class="nb">hsl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="kt">%</span><span class="p">,</span> <span class="mi">13</span><span class="kt">%</span><span class="p">);</span>
  <span class="k">text-indent</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="kp">-webkit-</span><span class="k">animation</span><span class="p">:</span> <span class="n">space_button</span> <span class="mi">500</span><span class="kt">ms</span> <span class="kc">ease</span> <span class="mi">0</span> <span class="mi">1</span> <span class="kc">normal</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>擬似要素が:checkedの時にだけアニメーションを指定することで、空白ボタンがチェックされたらアニメーションするようにしています。<br />
実際のアニメーションの動作はこうなっています。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-css" data-lang="css"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-css" data-lang="css"><span></span><span class="p">@</span><span class="k">-webkit-keyframes</span> <span class="nt">space_button</span> <span class="p">{</span>
  <span class="nt">0</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mi">1</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mi">1</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">10</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">.9</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">.9</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">20</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">30</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">.4</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">.4</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">40</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">50</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">.3</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">.3</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">60</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">70</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">80</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">90</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mi">0</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mi">0</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">100</span><span class="o">%</span> <span class="p">{</span>
    <span class="k">text-indent</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
    <span class="k">letter-spacing</span><span class="p">:</span> <span class="mf">-.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>このように、ここではtext-indentとletter-spacingを使うことで文字の間隔を変えています。<br />
あとは10%ごとに跳ね返ってるように見えるように間隔を調整すれば完了です。<br />
空白を消してるぞ！っというような動きができたので個人的には非常に満足しています。</p>

<h2 id="実装解説-javascript">実装解説：JavaScript</h2>

<p>JavaScriptの解説ですね。<br />
おおまかに分けると、入力内容の同期、空白や改行の削除処理、Tabの処理、となっています。<br />
また、今回はライブラリとしてjQueryを使用しています。</p>

<h3 id="入力内容の同期">入力内容の同期</h3>

<p>特定の文字に色をつけるために、textareaとdivの内容を同期します。<br />
その際に、特定の文字をマークアップしたり、入力内容のエスケープを行います。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-javascript" data-lang="javascript"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="c1">// ～中略～</span>
<span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ～中略～</span>
  <span class="c1">// 入力された値を常に監視する</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;keydown keyup keypress change focus click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">inputWatch</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
  <span class="p">});</span>
  
  <span class="c1">// スクロールを同期する</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;keydown keyup keypress change scroll&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input_background&quot;</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">());</span>
  <span class="p">});</span>
  <span class="c1">// ～中略～</span>
<span class="p">});</span>



<span class="c1">// 入力内容を監視</span>
<span class="kd">function</span> <span class="nx">inputWatch</span><span class="p">(</span><span class="nx">inputText</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">inputText</span> <span class="o">=</span> <span class="nx">escapeHtml</span><span class="p">(</span><span class="nx">inputText</span><span class="p">);</span>
  
  <span class="c1">// 入力された文字列を可視化する</span>
  <span class="nx">inputText</span> <span class="o">=</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ /g</span><span class="p">,</span> <span class="s2">&quot;&lt;pre class=\&quot;space\&quot;&gt; &lt;/pre&gt;&quot;</span><span class="p">);</span> <span class="c1">// 半角スペース</span>
  <span class="nx">inputText</span> <span class="o">=</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/　/g</span><span class="p">,</span> <span class="s2">&quot;&lt;pre class=\&quot;em_space\&quot;&gt;　&lt;/pre&gt;&quot;</span><span class="p">);</span> <span class="c1">// 全角スペース</span>
  <span class="nx">inputText</span> <span class="o">=</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\t/g</span><span class="p">,</span> <span class="s2">&quot;&lt;pre class=\&quot;tab\&quot;&gt;   &lt;/pre&gt;&quot;</span><span class="p">);</span> <span class="c1">// タブ</span>
  <span class="nx">inputText</span> <span class="o">=</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n/g</span><span class="p">,</span> <span class="s2">&quot;&lt;pre class=\&quot;crlf\&quot;&gt;&lt;/pre&gt;&lt;br&gt;&quot;</span><span class="p">);</span> <span class="c1">// CRLF</span>
  <span class="nx">inputText</span> <span class="o">=</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r/g</span><span class="p">,</span> <span class="s2">&quot;&lt;pre class=\&quot;cr\&quot;&gt;&lt;/pre&gt;&lt;br&gt;&quot;</span><span class="p">);</span> <span class="c1">// CR</span>
  <span class="nx">inputText</span> <span class="o">=</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span> <span class="s2">&quot;&lt;pre class=\&quot;lf\&quot;&gt;&lt;/pre&gt;&lt;br&gt;&quot;</span><span class="p">);</span> <span class="c1">// LF</span>
    
  <span class="c1">// div要素の最後が&lt;br&gt;だとheightに反映されないようなので空白を最後に追加する</span>
  <span class="nx">inputText</span> <span class="o">+=</span> <span class="s2">&quot;　&quot;</span><span class="p">;</span>
  
  <span class="c1">// 入力内容と背景用の内容を同期させる</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input_background&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">inputText</span><span class="p">);</span>
<span class="p">}</span>



<span class="c1">// HTML用に文字列をエスケープする</span>
<span class="kd">function</span> <span class="nx">escapeHtml</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// エスケープ対象は「&amp;」「&lt;」「&gt;」「&quot;」「&#39;」</span>
  <span class="nx">string</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">);</span>
  <span class="nx">string</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">);</span>
  <span class="nx">string</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">);</span>
  <span class="nx">string</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&quot;/g</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;);</span>
<span class="s2">  string = string.replace(/\&#39;/g, &quot;</span><span class="err">&#39;&quot;</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>内容を同期する時は、内容が変更しそうなイベントをすべてバインドして、同期処理を走らせます。</p>

<h3 id="空白や改行の削除処理">空白や改行の削除処理</h3>

<p>空白や改行は正規表現で削除しています。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-javascript" data-lang="javascript"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="c1">// 改行削除</span>
<span class="kd">function</span> <span class="nx">newlineDelete</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">posStart</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionStart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">posEnd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionEnd</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">inputStr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  
  <span class="c1">// 範囲選択をしていない場合</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">===</span> <span class="nx">posEnd</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 改行をすべて削除</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#result&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">inputStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\n\r]/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="c1">// 範囲選択をしている場合</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">selStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">posEnd</span><span class="p">);</span>
    <span class="c1">// 改行をすべて削除</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#result&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">selStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\n\r]/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
  <span class="p">}</span>
  
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#result&quot;</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
<span class="p">}</span>



<span class="c1">// 空白削除</span>
<span class="kd">function</span> <span class="nx">spaceDelete</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">posStart</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionStart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">posEnd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionEnd</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">inputStr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  <span class="c1">// 内容をバックアップ</span>
  <span class="nx">backupStr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  <span class="nx">backupPos</span> <span class="o">=</span> <span class="nx">posStart</span><span class="p">;</span>
  
  <span class="c1">// 範囲選択をしていない場合</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">===</span> <span class="nx">posEnd</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 空白をすべて削除</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">inputStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[ 　\t]/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
    <span class="c1">// キャレットの位置から前にある空白の数だけキャレットの位置を前に移動する</span>
    <span class="kd">var</span> <span class="nx">moveCount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">posStart</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[ 　\t]/g</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">posStart</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[ 　\t]/g</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">posStart</span> <span class="o">-</span> <span class="nx">moveCount</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// 範囲選択をしている場合</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">selStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">posEnd</span><span class="p">);</span>
    <span class="c1">// 空白をすべて削除</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">posStart</span><span class="p">)</span> <span class="o">+</span> <span class="nx">selStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[ 　\t]/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posEnd</span><span class="p">,</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">posStart</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="c1">// 空白改行削除</span>
<span class="kd">function</span> <span class="nx">spaceNewlineDelete</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">posStart</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionStart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">posEnd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionEnd</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">inputStr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  
  <span class="c1">// 範囲選択をしていない場合</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">===</span> <span class="nx">posEnd</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 空白改行をすべて削除</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#result&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">inputStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[ 　\n\r\t]/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="c1">// 範囲選択をしている場合</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">selStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">posEnd</span><span class="p">);</span>
    <span class="c1">// 改行をすべて削除</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#result&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">selStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[ 　\n\r\t]/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
  <span class="p">}</span>
  
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#result&quot;</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>範囲選択をしていない場合は非常にシンプルなのですが、範囲を選択している時は選択範囲にのみ処理を実行させるようにすると処理が複雑になります。<br />
範囲選択をしている時は、選択範囲の始点と終点を取得し、それを基に処理を行います。</p>

<h3 id="tabの処理">Tabの処理</h3>

<p>ここが1番大変でした。<br />
ここに1番時間がかかりました。<br />
とりあえずソースはこんな感じです。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-javascript" data-lang="javascript"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84</code></pre></div></td><td class="code"><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="c1">// タブを入力</span>
<span class="kd">function</span> <span class="nx">insertTab</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">posStart</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionStart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">posEnd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionEnd</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">inputStr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  
  <span class="c1">// 範囲選択をしていない場合</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">===</span> <span class="nx">posEnd</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// カーソルの位置にタブを追加</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">posStart</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\t&quot;</span> <span class="o">+</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="c1">// カーソルの位置をタブの後ろに移動させる</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">posStart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// 範囲選択をしている場合</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">beforeSelStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">posStart</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">selStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">posEnd</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">afterSelStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posEnd</span><span class="p">,</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    
    <span class="c1">// 選択範囲始点の行頭にタブを追加</span>
    <span class="nx">beforeSelStrSplit</span> <span class="o">=</span> <span class="nx">beforeSelStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n|\r|\r\n/g</span><span class="p">);</span>
    <span class="nx">beforeSelStrSplit</span><span class="p">[</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;\t&quot;</span> <span class="o">+</span> <span class="nx">beforeSelStrSplit</span><span class="p">[</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="c1">// 選択範囲の行頭にタブを追加</span>
    <span class="nx">selStr</span> <span class="o">=</span> <span class="nx">selStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\n\r]/g</span><span class="p">,</span> <span class="s2">&quot;\n\t&quot;</span><span class="p">);</span>
    <span class="c1">// 分割した文字列を結合</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">selStr</span> <span class="o">+</span> <span class="nx">afterSelStr</span><span class="p">);</span>
    <span class="c1">// カーソルの選択範囲を維持する</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">posEnd</span> <span class="o">+</span> <span class="p">((</span><span class="nx">selStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[\n\r]/g</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">selStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[\n\r]/g</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="c1">// 行頭のタブを削除</span>
<span class="kd">function</span> <span class="nx">deleteTab</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">posStart</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionStart</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">posEnd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">selectionEnd</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">inputStr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  
  <span class="c1">// 範囲選択をしていない場合</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">===</span> <span class="nx">posEnd</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">beforeSelStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">posStart</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">afterSelStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    
    <span class="c1">// キャレットの行を取得</span>
    <span class="nx">beforeSelStrSplit</span> <span class="o">=</span> <span class="nx">beforeSelStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n|\r|\r\n/g</span><span class="p">);</span>
    <span class="nx">afterSelStrSplit</span> <span class="o">=</span> <span class="nx">afterSelStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n|\r|\r\n/g</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">beforeSelLineStr</span> <span class="o">=</span> <span class="nx">beforeSelStrSplit</span><span class="p">[</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">targetStr</span> <span class="o">=</span> <span class="nx">beforeSelLineStr</span> <span class="o">+</span> <span class="nx">afterSelStrSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">afterSelStrSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="c1">// 行頭のタブを削除</span>
    <span class="nx">beforeSelStrSplit</span><span class="p">[</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">targetStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\t/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="c1">// 分割した文字列を結合</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">afterSelStrSplit</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">));</span>
    <span class="c1">// カーソルの位置を維持する</span>
    <span class="kd">var</span> <span class="nx">moveCount</span> <span class="o">=</span> <span class="p">(</span><span class="nx">beforeSelLineStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\t/</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">-</span> <span class="nx">moveCount</span><span class="p">,</span> <span class="nx">posStart</span> <span class="o">-</span> <span class="nx">moveCount</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// 範囲選択をしている場合</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">beforeSelStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">posStart</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">selStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posStart</span><span class="p">,</span> <span class="nx">posEnd</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">afterSelStr</span> <span class="o">=</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">posEnd</span><span class="p">,</span> <span class="nx">inputStr</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    
    <span class="c1">// 対象となる行を取得</span>
    <span class="nx">beforeSelStrSplit</span> <span class="o">=</span> <span class="nx">beforeSelStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n|\r|\r\n/g</span><span class="p">);</span>
    <span class="nx">selStrSplit</span> <span class="o">=</span> <span class="nx">selStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n|\r|\r\n/g</span><span class="p">);</span>
    <span class="nx">afterSelStrSplit</span> <span class="o">=</span> <span class="nx">afterSelStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n|\r|\r\n/g</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">beforeSelLineStr</span> <span class="o">=</span> <span class="nx">beforeSelStrSplit</span><span class="p">[</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">afterSelLineStr</span> <span class="o">=</span> <span class="nx">selStrSplit</span><span class="p">[</span><span class="nx">selStrSplit</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">targetStr</span> <span class="o">=</span> <span class="nx">beforeSelLineStr</span> <span class="o">+</span> <span class="nx">selStr</span> <span class="o">+</span> <span class="nx">afterSelStrSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">beforeSelStrSplit</span><span class="p">[</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">afterSelStrSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="c1">// 行頭のタブを削除</span>
    <span class="nx">selStr</span> <span class="o">=</span> <span class="nx">targetStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\t/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n\t|\r\t|\r\n\t/g</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="c1">// 分割した文字列を結合</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">beforeSelStrSplit</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">selStr</span> <span class="o">+</span> <span class="nx">afterSelStrSplit</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">));</span>
    <span class="c1">// カーソルの位置を維持する</span>
    <span class="kd">var</span> <span class="nx">moveCountStart</span> <span class="o">=</span> <span class="p">(</span><span class="nx">beforeSelLineStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\t/</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">moveCountEnd</span> <span class="o">=</span> <span class="p">(</span><span class="nx">afterSelLineStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\t/</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">moveCountEnd</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">targetStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\n\t|\r\t|\r\n\t/g</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">targetStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\n\t|\r\t|\r\n\t/g</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#input&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">posStart</span> <span class="o">-</span> <span class="nx">moveCountStart</span><span class="p">,</span> <span class="nx">posEnd</span> <span class="o">-</span> <span class="nx">moveCountEnd</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>はい、ご覧のとおり複雑なことになってます。<br />
なぜかといいますと、textareaからは行頭というものを取得できないためです。<br />
改行記号を含んだ文字列として扱われます。<br />
なので、Shift + Tabをした場合や範囲選択をしている場合は、行頭を判別する処理が必要になります。<br />
また、Tab文字を入れたり消したりしますので、キャレットの位置がずれてしまいます。<br />
なので、変動した文字数を数えて、それに合わせてキャレットを移動させてあげています。<br />
ここらへんの処理がcontenteditableを使うと簡潔に書けそうな感じでした。（ブラウザは制限されるかも知れませんが。）</p>

<h2 id="まとめ">まとめ</h2>

<p>現時点でこのWebアプリはver.4です。<br />
ver.3では、Sfhit + Tab以外のキーボードからひと通りの処理に対応、空白文字可視化、などを行って制作時間は7時間くらい。<br />
ver.4では、Shift + Tab対応、範囲選択の処理に対応、デザイン変更、などを行って制作時間は12時間くらい。<br />
補助機能の実装に1番時間がかかってしまった。<br />
今までの合計製作時間は26時間くらいですね。<br />
非常に楽しく実装できて、とても勉強になって、一時期非常に役に立ったので、とても有意義でした。</p>

<h2 id="参考にさせていただいたサイト">参考にさせていただいたサイト</h2>

<ul>
<li><a href="http://qiita.com/yuku_t/items/516ec6fe59b77b93edc5" title="JavaScript - Facebookみたいにtextareaの一部を強調する - Qiita [キータ]">JavaScript &#8211; Facebookみたいにtextareaの一部を強調する &#8211; Qiita [キータ]</a></li>
<li><a href="http://www.backlog.jp/blog/2013/06/facebook-like-textarea.html" title="Facebookライクにテキストエリアを強調する方法 | Backlogブログ">Facebookライクにテキストエリアを強調する方法 | Backlogブログ</a></li>
<li><a href="http://ginpen.com/2012/12/24/fix-window-height/" title="CSSだけでウィンドウぴったりに表示する編集画面を作る。（CSS おれおれ Advent Calendar 2012 – 23日目） | Ginpen.com">CSSだけでウィンドウぴったりに表示する編集画面を作る。（CSS おれおれ Advent Calendar 2012 – 23日目） | Ginpen.com</a></li>
<li><a href="http://ginpen.com/2011/07/01/height-100-parcent/" title="CSSでheight:100%を使う方法について。 | Ginpen.com">CSSでheight:100%を使う方法について。 | Ginpen.com</a></li>
<li><a href="http://d.hatena.ne.jp/hokaccha/20111028/1319814792" title="textareaでタブを入力できるようにする - hokaccha.hamalog v2">textareaでタブを入力できるようにする &#8211; hokaccha.hamalog v2</a></li>
</ul>

</article>
<footer>
    <div>菅原 浩</div>
    <div><a href="https://github.com/5000164/profile">About</a></div>
</footer>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-51024599-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</body>
</html>

